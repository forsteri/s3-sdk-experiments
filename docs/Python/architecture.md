# S3 Uploader アーキテクチャ概要

## 概要

S3 Uploaderは、クラスベース設計により機能を明確に分離し、高い拡張性と保守性を実現したPythonアプリケーションです。本ドキュメントでは、システムの設計思想、コンポーネント間の関係、データフローについて詳しく説明します。

## 設計思想

### 1. 関心の分離（Separation of Concerns）

各クラスは明確な責任を持ち、相互に独立した機能を提供します：

- **設定管理**: 設定の読み込み、検証、管理
- **タスク実行**: アップロードタスクの処理とワークフロー管理
- **AWS連携**: S3クライアントの管理と認証
- **ファイル処理**: ファイルスキャン、アップロード実行
- **進捗管理**: リアルタイムでの進捗追跡
- **ログ管理**: 統一されたログ出力

### 2. 依存性注入（Dependency Injection）

クラス間の依存関係は明示的に注入され、テストの容易性と拡張性を高めています。

### 3. 設定駆動（Configuration-Driven）

JSONファイルによる設定管理により、コードの変更なしに動作を制御できます。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                          main.py                                │
│                    (エントリーポイント)                           │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Config & Logger                               │
│                (設定とログ初期化)                                │
│  - 設定ファイルの読み込み                                        │
│  - ログシステムの初期化                                          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                     TaskRunner                                  │
│               (タスク実行管理)                                    │
│  - アップロードタスクの実行                                        │
│  - ファイル/ディレクトリの判定                                     │
│  - 並列実行の調整                                                 │
└─────────────────────┬───────────────────────────────────────────┘
                      │
      ┌───────────────┼───────────────┐
      │               │               │
      ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│S3ClientMgr  │ │FileScanner  │ │UploadExecutor│
│(AWS認証)    │ │(ファイル検索)│ │(アップロード) │
└─────────────┘ └─────────────┘ └─────────────┘
                                       │
                                       ▼
                               ┌─────────────┐
                               │ParallelUpload│
                               │Executor     │
                               │(並列実行)   │
                               └─────────────┘
```

## 主要コンポーネント

### 1. エントリーポイント層

#### main.py
- アプリケーションの起動点
- 例外処理と終了コードの管理
- 最小限のロジックで責任を限定

### 2. 調整層（Orchestration Layer）

#### main.py
- アプリケーション全体の調整を担当
- 設定の読み込みとバリデーション
- 各コンポーネントの初期化と連携

**主な責任**:
- 設定ファイルの読み込み
- ログシステムの初期化
- TaskRunnerの作成と実行

### 3. 実行層（Execution Layer）

#### TaskRunner
- 個別のアップロードタスクの実行を管理
- ファイル/ディレクトリの処理分岐
- 並列実行の制御

**主な責任**:
- アップロードタスクの順次実行
- ファイルタイプの判定と適切な処理の選択
- 成功/失敗の集計

### 4. サービス層（Service Layer）

#### S3ClientManager
- AWS S3クライアントの作成と管理
- 認証情報の処理
- AssumeRoleの実行

**主な責任**:
- S3クライアントの生成
- 認証方式の選択（プロファイル、AssumeRole）
- 認証エラーの処理

#### UploadExecutor
- 単一ファイルのアップロード実行
- リトライ機能
- 進捗追跡の統合

**主な責任**:
- ファイルアップロードの実行
- エラーハンドリングとリトライ
- 進捗情報の更新

#### ParallelUploadExecutor
- 複数ファイルの並列アップロード
- ThreadPoolExecutorの管理
- 結果の集約

**主な責任**:
- 並列実行の制御
- スレッドプールの管理
- 並列実行結果の集約

### 5. ユーティリティ層（Utility Layer）

#### FileScanner
- ファイルシステムのスキャン
- ファイル情報の取得
- 除外パターンの適用

#### LoggerManager
- ログシステムの設定
- ハンドラーの管理
- 統一されたログ出力

#### ProgressTracker
- アップロード進捗の追跡
- リアルタイム表示
- 進捗情報の管理

### 6. データ層（Data Layer）

#### Config関連クラス
- 設定データの構造化
- バリデーションとパース
- 型安全性の確保

## データフロー

### 1. 初期化フロー

```
設定ファイル → Config.from_file() → Config オブジェクト
     ↓
LoggingConfig → LoggerManager.setup() → Logger
     ↓
AWSConfig → S3ClientManager → S3 Client
     ↓
UploadOptions → UploadExecutor → 実行可能状態
```

### 2. アップロード実行フロー

```
UploadTask → TaskRunner.run_all_tasks()
     ↓
ファイル/ディレクトリ判定
     ↓
┌─────────────────┬─────────────────┐
│ 単一ファイル     │ ディレクトリ     │
│      ↓          │      ↓          │
│ UploadExecutor  │ FileScanner     │
│      ↓          │      ↓          │
│ S3アップロード   │ ParallelUpload  │
│                 │ Executor        │
│                 │      ↓          │
│                 │ 並列S3アップロード│
└─────────────────┴─────────────────┘
     ↓
結果集約 → ログ出力 → 完了
```

### 3. エラーハンドリングフロー

```
エラー発生 → ログ記録 → リトライ判定
     ↓
┌─────────────────┬─────────────────┐
│ リトライ可能     │ リトライ不可     │
│      ↓          │      ↓          │
│ 指数バックオフ    │ エラー結果返却   │
│      ↓          │                 │
│ 再実行          │                 │
└─────────────────┴─────────────────┘
```

## 設計パターン

### 1. Factory Pattern
- `S3ClientManager`: AWS設定に基づいて適切なS3クライアントを生成
- `TransferConfigManager`: アップロード設定に基づいてTransferConfigを生成

### 2. Strategy Pattern
- 認証方式の選択（プロファイル、AssumeRole、デフォルト）
- ファイル処理方式の選択（単一ファイル、ディレクトリ）

### 3. Builder Pattern
- `Config`クラス: 複雑な設定オブジェクトの構築
- `LoggerManager`: ログ設定の段階的な構築

### 4. Singleton Pattern
- `LoggerManager`: アプリケーション全体で単一のログ設定を共有

## 拡張性

### 1. 新しい認証方式の追加
`S3ClientManager._create_client()`メソッドを拡張することで、新しい認証方式を追加できます。

### 2. 新しいアップロード方式の追加
`UploadExecutor`を継承して新しいアップロード戦略を実装できます。

### 3. 新しい進捗表示方式の追加
`ProgressTracker`インターフェースを実装して、新しい進捗表示方式を追加できます。

### 4. 新しいファイルフィルタリング方式の追加
`FileScanner`クラスを拡張して、新しいフィルタリング条件を追加できます。

## パフォーマンス最適化

### 1. メモリ効率
- ファイルストリーミング: 大きなファイルを分割して処理
- 適切なチャンクサイズ: メモリ使用量とパフォーマンスのバランス

### 2. 並列処理
- ThreadPoolExecutor: I/Oバウンドなタスクの並列実行
- 適切なワーカー数: システムリソースと性能のバランス

### 3. リトライ戦略
- 指数バックオフ: ネットワーク障害時の効率的な再試行
- 適切なタイムアウト: 長時間のブロック回避

## テスト戦略

### 1. 単体テスト
- 各クラスの独立したテスト
- モックを使用した依存関係の分離

### 2. 統合テスト
- コンポーネント間の連携テスト
- 実際のAWS環境での動作確認

### 3. エンドツーエンドテスト
- 実際のワークフローでの動作確認
- 設定ファイルから実行まで全体のテスト

## セキュリティ考慮事項

### 1. 認証情報の保護
- 設定ファイルでの平文保存回避
- 環境変数の活用
- AssumeRoleによる権限の最小化

### 2. ログの安全性
- 認証情報のログ出力回避
- 適切なログレベルの設定
- 機密情報のマスキング

### 3. エラーハンドリング
- 詳細なエラー情報の適切な処理
- 機密情報の漏洩防止
- 適切なエラーメッセージの提供

## 今後の改善案

### 1. 機能拡張
- 他のクラウドストレージサービスへの対応
- 暗号化オプションの追加
- メタデータ管理の強化

### 2. 運用性向上
- メトリクス収集
- ヘルスチェック機能
- 設定の動的リロード

### 3. パフォーマンス向上
- 非同期処理の導入
- キャッシュ機能の追加
- 差分アップロード機能